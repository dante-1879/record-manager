<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Transaction Manager</title>
    
    <!-- Load XLSX library from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
            border-bottom: 3px solid #3498db;
            padding-bottom: 15px;
        }

        .upload-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .upload-box {
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            background: #fafbfc;
        }

        .upload-box:hover {
            border-color: #3498db;
            background: #f0f8ff;
        }

        .upload-box h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .upload-box input[type="file"] {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }

        .status {
            margin-top: 10px;
            font-weight: 500;
            color: #666;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
        }

        .search-group {
            flex: 1;
            min-width: 250px;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        #results {
            display: none;
            margin-top: 30px;
        }

        .results-header {
            margin-bottom: 25px;
        }

        .results-header h2 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .balance-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .balance-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3498db;
        }

        .balance-item.total-bills {
            border-left-color: #e74c3c;
        }

        .balance-item.total-credits {
            border-left-color: #27ae60;
        }

        .balance-item.net-balance {
            border-left-color: #f39c12;
            font-weight: bold;
        }

        .balance-item.net-balance.positive {
            border-left-color: #e74c3c;
        }

        .balance-item.net-balance.negative {
            border-left-color: #27ae60;
        }

        .balance-item div:first-child {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .balance-item div:last-child {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .records-table th,
        .records-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .records-table th {
            background: #34495e;
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 12px;
        }

        .records-table tr:hover {
            background: #f8f9fa;
        }

        .amount-bill {
            color: #e74c3c;
            font-weight: 600;
        }

        .amount-credit {
            color: #27ae60;
            font-weight: 600;
        }

        .no-results {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 40px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .company-header td {
            background: #ecf0f1 !important;
            font-weight: bold;
            color: #2c3e50;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .upload-section {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .records-table {
                font-size: 14px;
            }

            .records-table th,
            .records-table td {
                padding: 8px;
            }
        }

        .info-box {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .info-box h3 {
            color: #2d6e2d;
            margin-bottom: 10px;
        }

        .info-box ul {
            margin-left: 20px;
            color: #2d6e2d;
        }

        .info-box li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíº Business Transaction Manager</h1>
        
        <div class="info-box">
            <h3>üìã How to Use This Application:</h3>
            <ul>
                <li><strong>CSV Files:</strong> Upload separate Bills/Invoices and Credits/Payments CSV files</li>
                <li><strong>Excel Files:</strong> Upload a single Excel file with "Invoices" and "Payments" sheets</li>
                <li><strong>Required Columns:</strong> Each file must have "Name" (company) and "Total" (amount) columns</li>
                <li><strong>Search:</strong> Enter company name to filter results, or leave empty to see all records</li>
                <li><strong>Export:</strong> Download results as a single CSV file with running balances</li>
            </ul>
        </div>

        <div class="upload-section">
            <div class="upload-box">
                <h3>üìÑ Upload Bills/Invoices (CSV)</h3>
                <p>Upload CSV file containing your issued invoices</p>
                <input type="file" id="billsFile" accept=".csv" />
                <div id="billsStatus" class="status">No file selected</div>
            </div>

            <div class="upload-box">
                <h3>üí≥ Upload Credits/Payments (CSV)</h3>
                <p>Upload CSV file containing received payments</p>
                <input type="file" id="creditsFile" accept=".csv" />
                <div id="creditsStatus" class="status">No file selected</div>
            </div>

            <div class="upload-box">
                <h3>üìä Upload Excel File</h3>
                <p>Upload Excel file with "Invoices" and "Payments" sheets</p>
                <input type="file" id="excelFile" accept=".xlsx,.xls" />
                <div id="excelStatus" class="status">No file selected</div>
            </div>
        </div>

        <div class="controls">
            <div class="search-group">
                <input type="text" id="searchInput" placeholder="üîç Search by company name..." />
            </div>
            <button id="searchBtn" class="btn btn-primary">Search</button>
            <button id="exportBtn" class="btn btn-success">üì• Export CSV</button>
            <button id="clearBtn" class="btn btn-secondary">Clear Results</button>
            <button id="clearFilesBtn" class="btn btn-danger">üóëÔ∏è Clear All Files</button>
        </div>

        <div id="results">
            <div class="results-header">
                <h2 id="resultsTitle">Results</h2>
                <div id="balanceSummary" class="balance-summary"></div>
            </div>
            <div id="recordsContainer"></div>
        </div>
    </div>

    <script>
        class RecordManager {
            constructor() {
                this.billsData = [];
                this.creditsData = [];
                this.billsHeaders = [];
                this.creditsHeaders = [];
                this.init();
            }

            init() {
                // File input handlers
                document.getElementById('billsFile').addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files[0], 'bills');
                });

                document.getElementById('creditsFile').addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files[0], 'credits');
                });

                document.getElementById('excelFile').addEventListener('change', (e) => {
                    this.handleFileUpload(e.target.files[0], 'excel');
                });

                // Search handlers
                document.getElementById('searchBtn').addEventListener('click', () => {
                    this.performSearch();
                });

                document.getElementById('searchInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.performSearch();
                    }
                });

                document.getElementById('clearBtn').addEventListener('click', () => {
                    this.clearResults();
                });

                document.getElementById('clearFilesBtn').addEventListener('click', () => {
                    this.clearAllFiles();
                });

                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportToCSV();
                });
            }

            handleFileUpload(file, type) {
                if (!file) return;

                const statusElement = document.getElementById(`${type}Status`);
                statusElement.textContent = 'Loading...';

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        let data;
                        
                        if (type === 'excel') {
                            data = this.parseExcel(e.target.result);
                        } else {
                            data = this.parseCSV(e.target.result);
                        }
                        
                        if (type === 'bills') {
                            this.billsData = data;
                            this.billsHeaders = data.length > 0 ? data[0].headers : [];
                            statusElement.textContent = `‚úÖ ${data.length} invoices loaded`;
                        } else if (type === 'credits') {
                            this.creditsData = data;
                            this.creditsHeaders = data.length > 0 ? data[0].headers : [];
                            statusElement.textContent = `‚úÖ ${data.length} payments loaded`;
                        } else if (type === 'excel') {
                            // Excel data is already processed into bills and credits
                            const totalRecords = this.billsData.length + this.creditsData.length;
                            statusElement.textContent = `‚úÖ ${totalRecords} transactions loaded (${this.billsData.length} invoices, ${this.creditsData.length} payments)`;
                        }

                        statusElement.style.color = '#27ae60';
                        
                        // Automatically display all records after file upload
                        this.displayAllRecords();
                    } catch (error) {
                        statusElement.textContent = '‚ùå Error loading file';
                        statusElement.style.color = '#e74c3c';
                        console.error('Error parsing file:', error);
                        alert('Error parsing file: ' + error.message);
                    }
                };

                if (type === 'excel') {
                    reader.readAsArrayBuffer(file);
                } else {
                    reader.readAsText(file);
                }
            }

            parseCSV(csv) {
                const lines = csv.trim().split('\n');
                if (lines.length < 2) return [];

                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const headersLower = headers.map(h => h.toLowerCase());
                const data = [];

                // Find the name and total columns (flexible column names)
                const nameColumn = this.findColumn(headersLower, ['name', 'company', 'client', 'vendor', 'supplier']);
                const totalColumn = this.findColumn(headersLower, ['total', 'amount', 'sum', 'value', 'price']);

                if (nameColumn === -1 || totalColumn === -1) {
                    throw new Error('Could not find Name and Total columns in CSV. Please ensure your CSV has columns named "Name" and "Total" (or similar variants).');
                }

                for (let i = 1; i < lines.length; i++) {
                    const row = this.parseCSVRow(lines[i]);
                    if (row.length > Math.max(nameColumn, totalColumn)) {
                        const name = row[nameColumn] ? row[nameColumn].trim().replace(/"/g, '') : '';
                        const totalValue = row[totalColumn] ? row[totalColumn].replace(/[,$"]/g, '') : '0';
                        const total = parseFloat(totalValue) || 0;
                        
                        if (name && total !== 0) {
                            // Create object with all column data
                            const rowData = {};
                            headers.forEach((header, index) => {
                                rowData[header] = row[index] ? row[index].trim().replace(/"/g, '') : '';
                            });

                            data.push({
                                name: name,
                                total: total,
                                headers: headers,
                                rowData: rowData,
                                originalRow: row
                            });
                        }
                    }
                }

                return data;
            }

            parseExcel(buffer) {
                if (typeof XLSX === 'undefined') {
                    throw new Error('XLSX library not loaded. Please refresh the page and ensure you have an internet connection.');
                }

                const workbook = XLSX.read(buffer, { type: 'array' });
                const sheetNames = workbook.SheetNames;

                // Find bills/invoices and credits/payments sheets
                const billsSheet = this.findSheet(sheetNames, ['bill', 'invoice', 'inv']);
                const creditsSheet = this.findSheet(sheetNames, ['credit', 'payment', 'pay', 'receipt']);

                // Clear existing data
                this.billsData = [];
                this.creditsData = [];
                this.billsHeaders = [];
                this.creditsHeaders = [];

                if (billsSheet) {
                    const billsWorksheet = workbook.Sheets[billsSheet];
                    const billsCSV = XLSX.utils.sheet_to_csv(billsWorksheet);
                    this.billsData = this.parseCSV(billsCSV);
                    this.billsHeaders = this.billsData.length > 0 ? this.billsData[0].headers : [];
                }

                if (creditsSheet) {
                    const creditsWorksheet = workbook.Sheets[creditsSheet];
                    const creditsCSV = XLSX.utils.sheet_to_csv(creditsWorksheet);
                    this.creditsData = this.parseCSV(creditsCSV);
                    this.creditsHeaders = this.creditsData.length > 0 ? this.creditsData[0].headers : [];
                }

                if (!billsSheet && !creditsSheet) {
                    throw new Error('Could not find sheets with names containing: bills, invoices, credits, payments. Please ensure your Excel file has sheets named "Invoices" and "Payments" (or similar).');
                }

                return { processed: true };
            }

            findSheet(sheetNames, keywords) {
                for (const keyword of keywords) {
                    const sheet = sheetNames.find(name => 
                        name.toLowerCase().includes(keyword)
                    );
                    if (sheet) return sheet;
                }
                return null;
            }

            parseCSVRow(row) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < row.length; i++) {
                    const char = row[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current.trim());
                return result;
            }

            findColumn(headers, possibleNames) {
                for (const name of possibleNames) {
                    const index = headers.findIndex(h => h.toLowerCase().includes(name));
                    if (index !== -1) return index;
                }
                return -1;
            }

            performSearch() {
                const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
                
                if (this.billsData.length === 0 && this.creditsData.length === 0) {
                    alert('Please upload at least one file first');
                    return;
                }

                if (searchTerm) {
                    const results = this.searchRecords(searchTerm);
                    this.displayResults(results, searchTerm);
                } else {
                    this.displayAllRecords();
                }
            }

            displayAllRecords() {
                if (this.billsData.length === 0 && this.creditsData.length === 0) {
                    return;
                }

                // Get all records
                const results = this.searchRecords(''); // Empty search gets all records
                this.currentResults = results; // Store current results for export
                this.displayCompanyTables(results);
            }

            searchRecords(searchTerm) {
                let bills, credits;
                
                if (searchTerm === '') {
                    // Get all records
                    bills = this.billsData;
                    credits = this.creditsData;
                } else {
                    // Filter by search term
                    bills = this.billsData.filter(record => 
                        record.name.toLowerCase().includes(searchTerm)
                    );

                    credits = this.creditsData.filter(record => 
                        record.name.toLowerCase().includes(searchTerm)
                    );
                }

                // Combine and organize by company name
                const allRecords = [];
                const companyMap = new Map();

                // Process bills
                bills.forEach(bill => {
                    const key = bill.name.toLowerCase();
                    if (!companyMap.has(key)) {
                        companyMap.set(key, {
                            name: bill.name,
                            bills: [],
                            credits: []
                        });
                    }
                    companyMap.get(key).bills.push(bill);
                    allRecords.push({
                        name: bill.name,
                        type: 'bill',
                        amount: this.getTotalColumnValue(bill),
                        headers: bill.headers,
                        rowData: bill.rowData,
                        originalData: bill
                    });
                });

                // Process credits
                credits.forEach(credit => {
                    const key = credit.name.toLowerCase();
                    if (!companyMap.has(key)) {
                        companyMap.set(key, {
                            name: credit.name,
                            bills: [],
                            credits: []
                        });
                    }
                    companyMap.get(key).credits.push(credit);
                    allRecords.push({
                        name: credit.name,
                        type: 'credit',
                        amount: this.getTotalColumnValue(credit),
                        headers: credit.headers,
                        rowData: credit.rowData,
                        originalData: credit
                    });
                });

                return {
                    records: allRecords,
                    summary: this.calculateSummary(companyMap),
                    availableHeaders: this.getAvailableHeaders(),
                    companyMap: companyMap
                };
            }

            getAvailableHeaders() {
                const allHeaders = new Set();
                
                // Add bills headers
                this.billsHeaders.forEach(header => allHeaders.add(header));
                
                // Add credits headers
                this.creditsHeaders.forEach(header => allHeaders.add(header));
                
                return Array.from(allHeaders);
            }

            calculateSummary(companyMap) {
                let totalBills = 0;
                let totalCredits = 0;
                const companySummaries = [];

                companyMap.forEach((data, key) => {
                    const billSum = data.bills.reduce((sum, bill) => {
                        const totalValue = this.getTotalColumnValue(bill);
                        return sum + totalValue;
                    }, 0);
                    
                    const creditSum = data.credits.reduce((sum, credit) => {
                        const totalValue = this.getTotalColumnValue(credit);
                        return sum + totalValue;
                    }, 0);
                    
                    const balance = billSum - creditSum;

                    totalBills += billSum;
                    totalCredits += creditSum;

                    companySummaries.push({
                        name: data.name,
                        billSum,
                        creditSum,
                        balance
                    });
                });

                return {
                    totalBills,
                    totalCredits,
                    netBalance: totalBills - totalCredits,
                    companySummaries
                };
            }

            getTotalColumnValue(record) {
                const totalColumn = record.headers.find(header => 
                    header.toLowerCase() === 'total' || header.toLowerCase() === 'amount'
                );
                
                if (totalColumn) {
                    const value = record.rowData[totalColumn] || '0';
                    return parseFloat(value.toString().replace(/[,$]/g, '')) || 0;
                }
                
                return record.total || 0;
            }

            displayResults(results, searchTerm) {
                this.currentResults = results;
                
                const resultsTitle = document.getElementById('resultsTitle');
                if (results.records.length === 0) {
                    resultsTitle.textContent = `No records found for "${searchTerm}"`;
                } else {
                    resultsTitle.textContent = `Records for "${searchTerm}" (${results.records.length} transactions)`;
                }
                
                this.displayCompanyTables(results);
            }

            displayCompanyTables(results) {
                const resultsSection = document.getElementById('results');
                const resultsTitle = document.getElementById('resultsTitle');
                const balanceSummary = document.getElementById('balanceSummary');
                const recordsContainer = document.getElementById('recordsContainer');

                if (results.records.length === 0) {
                    resultsTitle.textContent = 'No records found';
                    balanceSummary.innerHTML = '';
                    recordsContainer.innerHTML = '<div class="no-results">No records found. Please upload files first.</div>';
                    resultsSection.style.display = 'block';
                    return;
                }

                const totalCompanies = results.companyMap.size;
                if (!resultsTitle.textContent.includes('for "')) {
                    resultsTitle.textContent = `All Records (${results.records.length} transactions from ${totalCompanies} companies)`;
                }

                const summary = results.summary;
                const netBalanceClass = summary.netBalance >= 0 ? 'positive' : 'negative';
                const netBalanceText = summary.netBalance >= 0 ? 
                    `+${this.formatCurrency(summary.netBalance)}` : 
                    `${this.formatCurrency(summary.netBalance)}`;

                balanceSummary.innerHTML = `
                    <div class="balance-item total-bills">
                        <div>Total Invoices</div>
                        <div>${this.formatCurrency(summary.totalBills)}</div>
                    </div>
                    <div class="balance-item total-credits">
                        <div>Total Payments</div>
                        <div>${this.formatCurrency(summary.totalCredits)}</div>
                    </div>
                    <div class="balance-item net-balance ${netBalanceClass}">
                        <div>Outstanding Balance</div>
                        <div>${netBalanceText}</div>
                    </div>
                `;

                // Create separate table for each company
                let allTablesHTML = '';
                const allHeaders = results.availableHeaders;

                const sortedCompanies = Array.from(results.companyMap.entries())
                    .sort(([a], [b]) => a.localeCompare(b));

                sortedCompanies.forEach(([companyKey, companyData]) => {
                    const companyRecords = results.records.filter(r => 
                        r.name.toLowerCase() === companyKey
                    );

                    const billSum = companyData.bills.reduce((sum, bill) => {
                        const totalValue = this.getTotalColumnValue(bill);
                        return sum + totalValue;
                    }, 0);
                    
                    const creditSum = companyData.credits.reduce((sum, credit) => {
                        const totalValue = this.getTotalColumnValue(credit);
                        return sum + totalValue;
                    }, 0);
                    
                    const balance = billSum - creditSum;

                    const balanceClass = balance >= 0 ? 'amount-bill' : 'amount-credit';
                    const balanceText = balance >= 0 ? 
                        `${this.formatCurrency(balance)}` : 
                        `-${this.formatCurrency(Math.abs(balance))}`;
                    const balanceStatus = balance > 0 ? 'Outstanding' : balance < 0 ? 'Overpaid' : 'Settled';

                    allTablesHTML += `
                        <div style="margin-bottom: 40px; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
                            <div style="background: #f8f9fa; padding: 15px; border-bottom: 1px solid #e0e0e0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                    <h3 style="margin: 0; color: #2c3e50;">${companyData.name}</h3>
                                    <div style="display: flex; gap: 15px; font-size: 0.9rem; flex-wrap: wrap;">
                                        <span>Invoices: <strong class="amount-bill">${this.formatCurrency(billSum)}</strong></span>
                                        <span>Payments: <strong class="amount-credit">${this.formatCurrency(creditSum)}</strong></span>
                                        <span>${balanceStatus}: <strong class="${balanceClass}">${balanceText}</strong></span>
                                    </div>
                                </div>
                            </div>
                            <div style="overflow-x: auto;">
                                <table class="records-table" style="margin: 0;">
                                    <thead>
                                        <tr>
                                            <th>Type</th>
                    `;

                    allHeaders.forEach(header => {
                        allTablesHTML += `<th>${header}</th>`;
                    });

                    allTablesHTML += `
                                            <th>Running Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                    `;

                    const sortedRecords = companyRecords.sort((a, b) => {
                        const typeCompare = a.type === 'bill' ? -1 : 1;
                        if (a.type !== b.type) return typeCompare;
                        
                        const dateA = a.rowData.Date || a.rowData.date || '';
                        const dateB = b.rowData.Date || b.rowData.date || '';
                        return dateA.localeCompare(dateB);
                    });

                    let runningBalance = 0;
                    sortedRecords.forEach(record => {
                        if (record.type === 'bill') {
                            runningBalance += record.amount;
                        } else {
                            runningBalance -= record.amount;
                        }

                        const balanceClass = runningBalance >= 0 ? 'amount-bill' : 'amount-credit';
                        const balanceText = runningBalance >= 0 ? 
                            `${this.formatCurrency(runningBalance)}` : 
                            `-${this.formatCurrency(Math.abs(runningBalance))}`;

                        const typeClass = record.type === 'bill' ? 'amount-bill' : 'amount-credit';
                        const typeText = record.type.charAt(0).toUpperCase() + record.type.slice(1);

                        allTablesHTML += `
                            <tr>
                                <td class="${typeClass}">${typeText}</td>
                        `;

                        allHeaders.forEach(header => {
                            const value = record.rowData[header] || '-';
                            const isAmountColumn = header.toLowerCase().includes('amount') || 
                                                 header.toLowerCase().includes('total') ||
                                                 header.toLowerCase().includes('sum') ||
                                                 header.toLowerCase().includes('value') ||
                                                 header.toLowerCase().includes('price');
                            
                            if (isAmountColumn && value !== '-') {
                                const numValue = parseFloat(value.replace(/[,$]/g, ''));
                                if (!isNaN(numValue)) {
                                    allTablesHTML += `<td class="${record.type === 'bill' ? 'amount-bill' : 'amount-credit'}">${this.formatCurrency(numValue)}</td>`;
                                } else {
                                    allTablesHTML += `<td>${value}</td>`;
                                }
                            } else {
                                allTablesHTML += `<td>${value}</td>`;
                            }
                        });

                        allTablesHTML += `<td class="${balanceClass}">${balanceText}</td></tr>`;
                    });

                    allTablesHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                });

                recordsContainer.innerHTML = allTablesHTML;
                resultsSection.style.display = 'block';
            }

            clearAllFiles() {
                this.billsData = [];
                this.creditsData = [];
                this.billsHeaders = [];
                this.creditsHeaders = [];

                document.getElementById('billsFile').value = '';
                document.getElementById('creditsFile').value = '';
                document.getElementById('excelFile').value = '';

                document.getElementById('billsStatus').textContent = 'No file selected';
                document.getElementById('billsStatus').style.color = '#666';
                document.getElementById('creditsStatus').textContent = 'No file selected';
                document.getElementById('creditsStatus').style.color = '#666';
                document.getElementById('excelStatus').textContent = 'No file selected';
                document.getElementById('excelStatus').style.color = '#666';

                this.clearResults();
            }

            exportToCSV() {
                const results = this.currentResults;
                if (!results || results.records.length === 0) {
                    alert('No records to export. Please upload files first.');
                    return;
                }

                const allHeaders = results.availableHeaders;
                const csvHeaders = ['Company', 'Type', ...allHeaders.filter(h => h.toLowerCase() !== 'name'), 'Running Balance'];
                
                let csvContent = csvHeaders.join(',') + '\n';

                const sortedRecords = results.records.sort((a, b) => {
                    const nameCompare = a.name.localeCompare(b.name);
                    if (nameCompare !== 0) return nameCompare;
                    
                    const typeCompare = a.type === 'bill' ? -1 : 1;
                    if (a.type !== b.type) return typeCompare;
                    
                    const dateA = a.rowData.Date || a.rowData.date || '';
                    const dateB = b.rowData.Date || b.rowData.date || '';
                    return dateA.localeCompare(dateB);
                });

                let runningBalance = 0;
                let currentCompany = '';
                
                sortedRecords.forEach(record => {
                    if (record.name.toLowerCase() !== currentCompany) {
                        runningBalance = 0;
                        currentCompany = record.name.toLowerCase();
                        
                        if (csvContent !== csvHeaders.join(',') + '\n') {
                            csvContent += '\n';
                        }
                    }

                    if (record.type === 'bill') {
                        runningBalance += record.amount;
                    } else {
                        runningBalance -= record.amount;
                    }

                    const rowData = [
                        `"${record.name}"`,
                        `"${record.type.charAt(0).toUpperCase() + record.type.slice(1)}"`
                    ];

                    allHeaders.forEach(header => {
                        if (header.toLowerCase() !== 'name') {
                            const value = record.rowData[header] || '';
                            const cleanValue = String(value).replace(/"/g, '""');
                            rowData.push(`"${cleanValue}"`);
                        }
                    });

                    const balanceText = runningBalance >= 0 ? 
                        runningBalance.toFixed(2) : 
                        `-${Math.abs(runningBalance).toFixed(2)}`;
                    rowData.push(`"${balanceText}"`);

                    csvContent += rowData.join(',') + '\n';
                });

                csvContent += '\n\nSUMMARY\n';
                csvContent += `"Total Companies","${results.companyMap.size}"\n`;
                csvContent += `"Total Records","${results.records.length}"\n`;
                csvContent += `"Total Invoices","${results.summary.totalBills.toFixed(2)}"\n`;
                csvContent += `"Total Payments","${results.summary.totalCredits.toFixed(2)}"\n`;
                csvContent += `"Net Outstanding","${results.summary.netBalance.toFixed(2)}"\n`;

                if (results.summary.companySummaries.length > 1) {
                    csvContent += '\n\nCOMPANY SUMMARY\n';
                    csvContent += '"Company Name","Total Invoices","Total Payments","Outstanding Balance"\n';
                    
                    const sortedCompanySummaries = results.summary.companySummaries.sort((a, b) => 
                        a.name.localeCompare(b.name)
                    );

                    sortedCompanySummaries.forEach(company => {
                        csvContent += `"${company.name}","${company.billSum.toFixed(2)}","${company.creditSum.toFixed(2)}","${company.balance.toFixed(2)}"\n`;
                    });
                }

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                const currentDate = new Date().toISOString().split('T')[0];
                const filename = `business_transactions_${currentDate}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log('CSV exported successfully');
            }

            formatCurrency(amount) {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2
                }).format(Math.abs(amount));
            }

            clearResults() {
                document.getElementById('searchInput').value = '';
                document.getElementById('results').style.display = 'none';
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new RecordManager();
        });
    </script>
</body>
</html>
